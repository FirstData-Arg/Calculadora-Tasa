<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>Simulador de Financiación en Cuotas</title>
    
    <link href="bootstrap.min.css" rel="stylesheet">
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="calculadora.css" rel="stylesheet">
</head>

<body>

<div class="container" id="printSection">
    <div class="row">
        <div class="col-xs-9">
            <h1 class="page-header">Simulador de Financiación en Cuotas</h1>
        </div>
        <div class="col-xs-3">
            <a href="http://www.firstdata.com.ar"><img src="logo.png" class="img-responsive pull-right" alt="Responsive image"></a>
        </div>
    </div>
    <div class="row">
        <div class="col-xs-6">
            <div class="panel panel-primary">
                <div class="panel-heading">Datos</div>
                <div class="panel-body">
                    <div class="row">
                        <div class="col-xs-12">
                            <form role="form">
                                <div class="form-group">
                                    <label>Precio de Contado</label>
                                    <div class="form-group input-group">
                                        <span class="input-group-addon">$</span>
                                        <input id="precio" type="text" class="form-control" />
                                    </div>
                                    <span class="help-block">Ingrese el precio de contado del producto</span>
                                </div>
                                <div class="form-group">
                                    <label>Cantidad de Cuotas</label>
                                    <select class="form-control" id="cuotas">
                                          <option>Ahora 12</option>
                                          <option>Ahora 18</option>
                                          <option>2</option>
                                          <option>3</option>
                                          <option>4</option>
                                          <option>5</option>
                                          <option>6</option>
                                          <option>7</option>
                                          <option>8</option>
                                          <option>9</option>
                                          <option>10</option>
                                          <option>11</option>
                                          <option>12</option>
                                          <option>13</option>
                                          <option>14</option>
                                          <option>15</option>
                                          <option>16</option>
                                          <option>17</option>
                                          <option>18</option>
                                          <option>19</option>
                                          <option>20</option>
                                          <option>21</option>
                                          <option>22</option>
                                          <option>23</option>
                                          <option>24</option>
                                          <option>25</option>
                                          <option>26</option>
                                          <option>27</option>
                                          <option>28</option>
                                          <option>29</option>
                                          <option>30</option>
                                          <option>31</option>
                                          <option>32</option>
                                          <option>33</option>
                                          <option>34</option>
                                          <option>35</option>
                                          <option>36</option>
                                          <option>37</option>
                                          <option>38</option>
                                          <option>39</option>
                                          <option>40</option>
                                          <option>41</option>
                                          <option>42</option>
                                          <option>43</option>
                                          <option>44</option>
                                          <option>45</option>
                                          <option>46</option>
                                          <option>47</option>
                                          <option>48</option>
                                          <option>49</option>
                                          <option>50</option>
                                    </select>
                                    <span class="help-block">Ingrese la cantidad de coutas a pagar el producto</span>
                                </div>
                                <div class="form-group">
                                    <label>T.N.A.</label>
                                    <div class="form-group input-group">
                                        <input id="tna" type="text" class="form-control" readonly="readonly" />
                                        <span class="input-group-addon">%</span>
                                    </div>
                                    <span class="help-block">Ingrese la T.N.A. (Tasa Nominal Anual) de acuerdo a la cantidad de cuotas y la entidad bancaria</span>
                                </div>
                                <div class="form-inline">
                                    <div class="row">
                                        <div class="form-group col-xs-6" align="left">
                                            <button id="limpiar" type="button" class="btn btn-warning"><i class="fabutton fa fa-trash"></i> Limpiar</button>
                                        </div>
                                        <div class="form-group col-xs-6" align="right">
                                            <button id="calcular" type="button" class="btn btn-primary"><i class="fabutton fa fa-calculator"></i> Calcular</button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xs-6">
            <div class="panel panel-primary">
                <div class="panel-heading">Resultado</div>
                <div class="panel-body">
                    <div class="row">
                        <div class="col-xs-12">
                            <div class="form-group">
                                <p>
                                    <span class="lead">Precio de Contado: </span><span id="valor_contado" class="lead"></span>
                                </p>
                            </div>
                            <div class="form-group">
                                <p>
                                    <span class="lead">Cantidad de Cuotas: </span><span id="cant_cuotas" class="lead"></span>
                                </p>
                            </div>
                            <div class="form-group">
                                <p>
                                    <span class="lead">Precio de Venta en Cuotas: </span><span id="valor_total" class="lead"></span>
                                </p>
                            </div>
                            <div class="form-group">
                                <p>
                                    <span class="lead">Valor de cada Cuota: </span><span id="valor_cuota" class="lead"></span>
                                </p>
                            </div>
                            <div class="form-group">
                                <hr />
                            </div>
                            <div class="form-group">
                                <p>
                                    <span class="lead">T.E.A.: </span><span id="tea" class="lead"></span>
                                    <span class="help-block small">Tasa Efectiva Anual</span>
                                </p>
                            </div>
                            <div class="form-group">
                                <p>
                                    <span class="lead">C.F.T.: </span><span id="cft" class="lead"></span>
                                    <span class="help-block small">Costo Financiero Total</span>
                                </p>
                            </div>
                            <div class="form-group">
                                <p>
                                    <span class="lead">Coeficiente: </span><span id="coeficiente" class="lead"></span>
                                    <span class="help-block small">Factor de Venta Financiada con IVA</span>
                                </p>
                            </div>
                            <div class="form-inline">
                                <div class="row">
                                    <div class="form-group col-xs-12" align="center">
                                        <button id="imprimir" type="button" class="btn btn-info"><i class="fabutton fa fa-print"></i> Imprimir</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>        
        </div>
    </div>
    
    <div class="row">
        <div class="col-xs-12">
            <div class="panel panel-default">
                <div class="panel-body">
                    <span class="help-block small">Simulador elaborado en base a consulta formulada ante la Secretaría de Comercio de la Nación, en su carácter de autoridad de aplicación de la Ley 25.065. El mismo tiene una finalidad meramente orientativa. Para el cálculo del CFT contempla los conceptos aplicables a la generalidad de los casos: intereses e IVA de los intereses. Sin embargo, debe tenerse en cuenta que son computables las comisiones y otros cargos que se relacionen con la financiación de la venta y/o con el costo del medio de pago utilizado, que de aplicarse deberán incluirse en el cálculo del CFT; y no son computables el arancel del Artículo 15 de la Ley N° 25.065, retenciones o percepciones tributarias.</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="jquery.min.js"></script>

<script>

function TIR_Calc(CArray) {
    //IRRCalc
    min = -1.0;
    max = 1.0;
    do {
        guest = (min + max) / 2;
        NPV = 0;
        for (var j=0; j<CArray.length; j++) {
            NPV += CArray[j]/Math.pow((1+guest),j);
        }
        if (NPV > 0) {
            min = guest;
        }
        else {
            max = guest;
        }
    } while(Math.abs(NPV) > 0.000001);
    return guest;
}


function XNPV(rate, values) {
    var xnpv = 0.0;
    for (var key in values) {
        var tmp = values[key];
        var value = tmp.Flow;
        var date = tmp.Date;
        xnpv += value / Math.pow(1 + rate, date / 365);
    };
    return xnpv;
};

function XIRR(values, guess) {
    if (!guess) guess = 0.1;
    
    var x1 = 0.0;
    var x2 = guess;
    var f1 = XNPV(x1, values);
    var f2 = XNPV(x2, values);
    
    for (var i = 0; i < 100; i++) {
        if ((f1 * f2) < 0.0) break;
        if (Math.abs(f1) < Math.abs(f2)) {
            f1 = XNPV(x1 += 1.6 * (x1 - x2), values);
        }
        else {
            f2 = XNPV(x2 += 1.6 * (x2 - x1), values);
        }
    };
    
    if ((f1 * f2) > 0.0) return null;
    
    var f = XNPV(x1, values);
    if (f < 0.0) {
        var rtb = x1;
        var dx = x2 - x1;
    }
    else {
        var rtb = x2;
        var dx = x1 - x2;
    };
    
    for (var i = 0; i < 100; i++) {
        dx *= 0.5;
        var x_mid = rtb + dx;
        var f_mid = XNPV(x_mid, values);
        if (f_mid <= 0.0) rtb = x_mid;
        if ((Math.abs(f_mid) < 1.0e-6) || (Math.abs(dx) < 1.0e-6)) return x_mid;
    };
    
    return null;
};
    

var tabla_json = {"Ahora 12": {"cuotas": 12, "tna": "Descuento Directo 10%", "directo": true, "tea": 0.2217, "cft": 0.2789, "coeficiente": 1.1377},
                  "Ahora 18": {"cuotas": 18, "tna": "Descuento Directo 15%", "directo": true, "tea": 0.2379, "cft": 0.3030, "coeficiente": 1.2217},
                         "2": {"cuotas": 2,  "tna": 42},
                         "3": {"cuotas": 3,  "tna": 42},
                         "4": {"cuotas": 4,  "tna": 42},
                         "5": {"cuotas": 5,  "tna": 42},
                         "6": {"cuotas": 6,  "tna": 42},
                         "7": {"cuotas": 7,  "tna": 45},
                         "8": {"cuotas": 8,  "tna": 45},
                         "9": {"cuotas": 9,  "tna": 45},
                        "10": {"cuotas": 10, "tna": 45},
                        "11": {"cuotas": 11, "tna": 45},
                        "12": {"cuotas": 12, "tna": 45},
                        "13": {"cuotas": 13, "tna": 46},
                        "14": {"cuotas": 14, "tna": 46},
                        "15": {"cuotas": 15, "tna": 46},
                        "16": {"cuotas": 16, "tna": 46},
                        "17": {"cuotas": 17, "tna": 46},
                        "18": {"cuotas": 18, "tna": 46},
                        "19": {"cuotas": 19, "tna": 46},
                        "20": {"cuotas": 20, "tna": 46},
                        "21": {"cuotas": 21, "tna": 46},
                        "22": {"cuotas": 22, "tna": 46},
                        "23": {"cuotas": 23, "tna": 46},
                        "24": {"cuotas": 24, "tna": 46},
                        "25": {"cuotas": 25, "tna": 46},
                        "26": {"cuotas": 26, "tna": 46},
                        "27": {"cuotas": 27, "tna": 46},
                        "28": {"cuotas": 28, "tna": 46},
                        "29": {"cuotas": 29, "tna": 46},
                        "30": {"cuotas": 30, "tna": 46},
                        "31": {"cuotas": 31, "tna": 46},
                        "32": {"cuotas": 32, "tna": 46},
                        "33": {"cuotas": 33, "tna": 46},
                        "34": {"cuotas": 34, "tna": 46},
                        "35": {"cuotas": 35, "tna": 46},
                        "36": {"cuotas": 36, "tna": 46},
                        "37": {"cuotas": 37, "tna": 46},
                        "38": {"cuotas": 38, "tna": 46},
                        "39": {"cuotas": 39, "tna": 46},
                        "40": {"cuotas": 40, "tna": 46},
                        "41": {"cuotas": 41, "tna": 46},
                        "42": {"cuotas": 42, "tna": 46},
                        "43": {"cuotas": 43, "tna": 46},
                        "44": {"cuotas": 44, "tna": 46},
                        "45": {"cuotas": 45, "tna": 46},
                        "46": {"cuotas": 46, "tna": 46},
                        "47": {"cuotas": 47, "tna": 46},
                        "48": {"cuotas": 48, "tna": 46},
                        "49": {"cuotas": 49, "tna": 46},
                        "50": {"cuotas": 50, "tna": 46}};
//var tna_array = [["Ahora12",0],["Ahora18",0],[2,42],[3,42],[4,42],[5,42],[6,42],[7,45],[8,45],[9,45],[10,45],[11,45],[12,45],[13,46],[14,46],[15,46],[16,46],[17,46],[18,46],[19,46],[20,46],[21,46],[22,46],[23,46],[24,46],[36,19],[50,19]];

function calcular() {
    var cuotas = tabla_json[$("#cuotas").val()]["cuotas"];
    if ($("#precio").val() == "") $("#precio").val("100");
    var precio = $("#precio").val().replace(",", ".") * 1.00;
    
    if (tabla_json[$("#cuotas").val()]["directo"]) {
        // Planes especiales del gobierno, tasa directa
        var tea = tabla_json[$("#cuotas").val()]["tea"];
        var cft = tabla_json[$("#cuotas").val()]["cft"];
        var coeficiente_con_iva = tabla_json[$("#cuotas").val()]["coeficiente"];
    } else {
        // Resto de los planes, se calculan
       
        // Input
        var tna = $("#tna").val().replace(",", ".") / 100;
        var tea = (Math.pow((1 + (tna / cuotas)), cuotas) - 1) ;
        
        // Constantes
        var iva = 0.21;
        var arancel = 0.03;
        var dias_ano = 360;
        var dias_mes = 30;
        var dias_adelanto = 2;
        var dias_primer = dias_mes - dias_adelanto;
        
        // Calculos
        var pago_comercio = 0;
        // Calculo el acumulado de los pagos presenciales al comercio
        var cuota_sin_arancel = precio * (1-arancel) / cuotas;
        for (c = 0; c < cuotas; c++) {
            pago_comercio = pago_comercio + (cuota_sin_arancel / ((1+((dias_primer/dias_ano)*tna)) * Math.pow((1+((dias_mes/dias_ano)*tna)), c)));
        }
        var coeficiente_sin_iva = precio * (1-arancel) / pago_comercio;
        var tasa_directa = (1-arancel) - ((1-arancel) / coeficiente_sin_iva);
        var coeficiente_con_iva = (100 / (1-(tasa_directa * (1+iva)))) / 100;
        var precio_total_financiado = precio * coeficiente_con_iva;
        var descuento_financ_otorgante = precio_total_financiado * tasa_directa;
        var cuota_con_iva = (precio * coeficiente_con_iva) / cuotas;
        var cuota_financiada = precio_total_financiado / cuotas;

        // CFT
        var cft_array = [];
        cft_array.push({Date: 0, Flow: (-1 * precio)});
        for (c = 1; c <= cuotas; c++) {
            var d = (c == 1 ? dias_primer : dias_mes * c);
            cft_array.push({Date: d, Flow: cuota_con_iva});
        }
        var cft = XIRR(cft_array);
        
        // TEA
        var tea_array = [];
        tea_array.push({Date: 0, Flow: (-1 * (precio_total_financiado - descuento_financ_otorgante))});
        for (c = 1; c <= cuotas; c++) {
            var d = (c == 1 ? dias_primer : dias_mes * c);
            tea_array.push({Date: d, Flow: cuota_financiada});
        }
        var tea = XIRR(tea_array);
    }
    
    var coeficiente = coeficiente_con_iva;
    var valor_total = precio * coeficiente;
    var valor_cuota = (precio * coeficiente) / cuotas;
        
    $("#tea").text((tea * 100).toFixed(2) + "%");
    $("#cft").text((cft * 100).toFixed(2) + "%");
    $("#valor_contado").text("$" + precio.toFixed(2));
    $("#cant_cuotas").text($("#cuotas").val());
    $("#valor_total").text("$" + valor_total.toFixed(2));
    $("#valor_cuota").text("$" + valor_cuota.toFixed(2));
    $("#coeficiente").text(coeficiente.toFixed(4));
}

/*
function printElement(elem, append, delimiter) {
    var domClone = elem.cloneNode(true);

    var $printSection = document.getElementById("printSection");

    if (!$printSection) {
        $printSection = document.createElement("div");
        $printSection.id = "printSection";
        document.body.appendChild($printSection);
    }

    if (append !== true) {
        $printSection.innerHTML = "";
    }

    else if (append === true) {
        if (typeof (delimiter) === "string") {
            $printSection.innerHTML += delimiter;
        }
        else if (typeof (delimiter) === "object") {
            $printSection.appendChlid(delimiter);
        }
    }

    $printSection.appendChild(domClone);
}​
*/

$(document).ready(function() {
    $("#cuotas").val("Ahora 12");
    $("#tna").val(tabla_json[$("#cuotas").val()]["tna"]);
    
    $("#calcular").on("click", function() {
        calcular();
    }),
    $("#limpiar").on("click", function() {
        $("#tea").text("");
        $("#cft").text("");
        $("#valor_total").text("");
        $("#valor_cuota").text("");
        $("#cuotas").val("Ahora 12");
        $("#tna").val(tabla_json[$("#cuotas").val()]["tna"]);
        $("#precio").val("");
    }),
    $("#imprimir").on("click", function() {
        window.print();
    }),
    $("#cuotas").on("change", function() {
        //$("#tna").val(tna_array[$("#cuotas").val()][1]);
        $("#tna").val(tabla_json[$("#cuotas").val()]["tna"]);
        if (tabla_json[$("#cuotas").val()]["directo"]) $("#tna").prop('readonly', true);
        else $("#tna").prop('readonly', false);
    })
});
</script>

</body>

</html>
